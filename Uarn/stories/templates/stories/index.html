{% extends 'stories/base.html' %}
{% load static %}

{% block title %}–í—Å–µ –∏—Å—Ç–æ—Ä–∏–∏ ‚Äî Uarn Stories{% endblock %}

{% block content %}
<div class="container">
    <h1>–ò—Å—Ç–æ—Ä–∏–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π</h1>

    <!-- –¢–µ–≥–∏ -->
    <div class="tag-list">
        <a href="#" class="tag all active" data-query="">–í—Å–µ</a>
        {% for tag in tags %}
            <a href="#" class="tag" data-query="#{{ tag.name }}">#{{ tag.name }}</a>
        {% endfor %}
    </div>

  <!-- –ü–æ–ª–µ –ø–æ–∏—Å–∫–∞ (—Ç–µ–∫—Å—Ç) –∏ —Ñ–∏–ª—å—Ç—Ä –ø–æ —Ç–µ–≥–∞–º -->
  <div class="search-section">
    <div class="search-group">
      <label for="searchBox" class="search-label">
        <svg class="search-icon" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <circle cx="11" cy="11" r="8"></circle>
          <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
        </svg>
        –ü–æ–∏—Å–∫ –∏—Å—Ç–æ—Ä–∏–π
      </label>
      <input id="searchBox" placeholder="–í–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç –¥–ª—è –ø–æ–∏—Å–∫–∞..." class="search-input">
    </div>
    
    <div class="search-group">
      <label for="tagFilter" class="search-label">
        <svg class="search-icon" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <path d="M20.59 13.41l-7.17 7.17a2 2 0 0 1-2.83 0L2 12V2h10l8.59 8.59a2 2 0 0 1 0 2.82z"></path>
          <line x1="7" y1="7" x2="7.01" y2="7"></line>
        </svg>
        –§–∏–ª—å—Ç—Ä –ø–æ —Ç–µ–≥–∞–º
      </label>
      <input id="tagFilter" placeholder="–í–≤–µ–¥–∏—Ç–µ —Ç–µ–≥–∏ —á–µ—Ä–µ–∑ –∑–∞–ø—è—Ç—É—é..." class="search-input" />
    </div>
  </div>

  <!-- –†–∞–∑–¥–µ–ª–∏—Ç–µ–ª—å -->
  <div class="section-divider">
    <span class="divider-text">–ù–∞–π–¥–µ–Ω–Ω—ã–µ –∏—Å—Ç–æ—Ä–∏–∏</span>
  </div>

  <!-- –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è –∏—Å—Ç–æ—Ä–∏–π -->
  <div id="storiesContainer" class="stories-grid"></div>
</div>

<!-- –ü–æ–¥–∫–ª—é—á–∞–µ–º Tagify -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@yaireo/tagify/dist/tagify.css">
<script src="https://cdn.jsdelivr.net/npm/@yaireo/tagify"></script>

<script>
document.addEventListener('DOMContentLoaded', () => {
  const input = document.querySelector('#searchBox');
  const storiesContainer = document.getElementById('storiesContainer');

  // –°–ø–∏—Å–æ–∫ –≤—Å–µ—Ö —Ç–µ–≥–æ–≤ –¥–ª—è –∞–≤—Ç–æ–ø–æ–¥—Å–∫–∞–∑–∫–∏
  const existingTags = [
    {% for tag in tags %}
      "{{ tag.name }}",
    {% endfor %}
  ];

  // üí° –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º Tagify –¥–ª—è –ø–æ–ª—è —Ç–µ–≥–æ–≤ (–æ—Ç–¥–µ–ª—å–Ω–æ–µ –ø–æ–ª–µ –æ—Ç —Ç–µ–∫—Å—Ç–æ–≤–æ–≥–æ –ø–æ–∏—Å–∫–∞)
  const tagInput = document.querySelector('#tagFilter');
  const tagify = new Tagify(tagInput, {
    whitelist: existingTags,
    dropdown: {
      enabled: 1,
      maxItems: 10,
      classname: "tags-look",
      fuzzySearch: true,
      position: "input",
      highlightFirst: true,
    },
    enforceWhitelist: false,
    delimiters: ",", // —Ç–µ–≥–∏ —á–µ—Ä–µ–∑ –∑–∞–ø—è—Ç—É—é
    // –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º –∫–∏—Ä–∏–ª–ª–∏—Ü—É –∏ –ø—Ä–æ—á–∏–µ —Å–∏–º–≤–æ–ª—ã
    pattern: /^#?[^\s#]+$/u,
    // —Å–æ—Ö—Ä–∞–Ω—è–µ–º –∑–Ω–∞—á–µ–Ω–∏–µ input –∫–∞–∫ CSV: tag1,tag2
    originalInputValueFormat: valuesArr => valuesArr.map(v => v.value).join(',')
  });

  // –∫–æ—Ä–æ—Ç–∫–∏–µ —Å—Å—ã–ª–∫–∏ –Ω–∞ —ç–ª–µ–º–µ–Ω—Ç—ã
  const searchBox = document.querySelector('#searchBox');
  const tagFilterInput = tagInput; // original input element

  // üöÄ –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥–∞ –∏—Å—Ç–æ—Ä–∏–π
  function performSearchAndRender(q, tags) {
    const params = new URLSearchParams();
    if (q) params.set('q', q);
    if (tags) params.set('tags', tags);
    const url = `/search/?${params.toString()}`;
    fetch(url)
      .then(response => response.json())
      .then(data => {
        if (data.results.length === 0) {
          storiesContainer.innerHTML = `<p class="no-stories">–ù–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ üòî</p>`;
          return;
        }

        const html = data.results.map(s => `
          <div class="story-card">
            <h2>${s.title}</h2>
            <p class="meta">–ê–≤—Ç–æ—Ä: <strong>${s.author}</strong></p>
            <p class="excerpt">${s.excerpt}</p>
            ${s.tags && s.tags.length ? 
              `<div class="story-tags">${s.tags.map(t => `<span class="story-tag">#${t}</span>`).join(' ')}</div>` 
              : ''}
            <div class="card-actions">
              <a href="/story/${s.id}/" class="read-more">–ß–∏—Ç–∞—Ç—å –ø–æ–ª–Ω–æ—Å—Ç—å—é ‚Üí</a>
            </div>
          </div>
        `).join('');


        storiesContainer.innerHTML = html;
      });
  }
  storiesContainer.addEventListener('click', e => {
  if (e.target.classList.contains('toggle-btn')) {
    const card = e.target.closest('.story-card');
    const excerpt = card.querySelector('.excerpt');
    const full = card.querySelector('.full-content');

    if (full.classList.contains('hidden')) {
      full.classList.remove('hidden');
      excerpt.style.display = 'none';
      e.target.textContent = '–°–≤–µ—Ä–Ω—É—Ç—å';
    } else {
      full.classList.add('hidden');
      excerpt.style.display = '';
      e.target.textContent = '–ß–∏—Ç–∞—Ç—å –ø–æ–ª–Ω–æ—Å—Ç—å—é';
    }
  }
});


  // debounce helper
  function debounce(fn, wait) {
    let t = null;
    return function(...args) {
      clearTimeout(t);
      t = setTimeout(() => fn.apply(this, args), wait);
    };
  }

  // –í—ã–∑—ã–≤–∞–µ—Ç—Å—è –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ —Ç–µ–∫—Å—Ç–∞ –ø–æ–∏—Å–∫–∞
    const onSearchInput = debounce(() => {
    const q = searchBox.value.trim();
    const tags = tagFilterInput.value || '';
    performSearchAndRender(q, tags);
  }, 250);

  searchBox.addEventListener('input', onSearchInput);

  // –ü—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ —Ç–µ–≥–æ–≤ –∑–∞–ø—É—Å–∫–∞–µ–º –ø–æ–∏—Å–∫
  tagify.on('change', () => {
    const q = searchBox.value.trim();
    const tags = tagFilterInput.value || '';
    performSearchAndRender(q, tags);
  });

  // üîñ –ö–ª–∏–∫ –ø–æ —Ç–µ–≥—É —Å–≤–µ—Ä—Ö—É
  document.querySelectorAll('.tag').forEach(tagEl => {
    tagEl.addEventListener('click', e => {
      e.preventDefault();
      document.querySelectorAll('.tag').forEach(t => t.classList.remove('active'));
      tagEl.classList.add('active');

      const tagQuery = tagEl.dataset.query;
      if (tagQuery === '') {
        tagify.removeAllTags();
        searchBox.value = '';
        performSearchAndRender('', '');
      } else {
        tagify.addTags([tagQuery.replace('#', '')]);
        // let Tagify update the underlying input value, then trigger search
        setTimeout(() => {
          const q = searchBox.value.trim();
          const tags = tagFilterInput.value || '';
          performSearchAndRender(q, tags);
        }, 0);
      }
    });
  });

  // –ü–æ–∫–∞–∑–∞—Ç—å –≤—Å–µ –∏—Å—Ç–æ—Ä–∏–∏ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
  performSearchAndRender('');
});
</script>

{% endblock %}
